<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CAISA | Therapist Mic ‚Üí n8n Webhook</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121834;
      --ink: #e7ebff;
      --muted: #a8b0d9;
      --accent: #8aa3ff;
      --good: #32d48e;
      --warn: #ffb147;
      --bad: #ff6b6b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: linear-gradient(180deg, #0b1020, #0a0f2a);
      color: var(--ink);
    }

    .wrap {
      max-width: 900px;
      margin: 32px auto;
      padding: 24px;
    }

    .card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      letter-spacing: 0.2px;
    }

    p.lead {
      margin: 0 0 16px;
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }

    input[type="text"],
    input[type="url"],
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .25);
      color: var(--ink);
      outline: none;
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      color: #0a0f2a;
      background: var(--accent);
      box-shadow: 0 8px 16px rgba(138, 163, 255, .35);
    }

    .btn.ghost {
      background: transparent;
      color: var(--ink);
      border: 1px solid rgba(255, 255, 255, .2);
      box-shadow: none;
    }

    .btn.warn {
      background: var(--warn);
    }

    .btn.good {
      background: var(--good);
    }

    .btn.bad {
      background: var(--bad);
    }

    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .18);
      color: var(--muted);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .mt8 {
      margin-top: 8px
    }

    .mt12 {
      margin-top: 12px
    }

    .mt16 {
      margin-top: 16px
    }

    .mt24 {
      margin-top: 24px
    }

    .mt32 {
      margin-top: 32px
    }

    audio {
      width: 100%;
      margin-top: 8px;
    }

    pre {
      background: #0a0f2a;
      border: 1px solid rgba(255, 255, 255, .08);
      padding: 12px;
      border-radius: 12px;
      overflow: auto;
      max-height: 260px;
    }

    .footer {
      color: var(--muted);
      font-size: 12px;
      margin-top: 18px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>CAISA Demo ¬∑ Therapist Mic ‚Üí n8n Webhook</h1>
      <p class="lead">Record a short utterance, then POST it to your n8n Webhook as <span
          class="mono">multipart/form-data</span> (<span class="mono">file</span> + metadata). Designed for the
        self‚Äëhosted Whisper path.</p>

      <div class="grid">
        <div>
          <label for="webhook">n8n Webhook URL (production)</label>
          <input id="webhook" type="url" placeholder="https://your-n8n.example.com/webhook/caisa/turn" />
        </div>
        <div>
          <label for="apikey">Optional Header (x-caisa-key)</label>
          <input id="apikey" type="text" placeholder="leave blank if not required" />
        </div>
      </div>

      <div class="grid mt16">
        <div>
          <label for="session">Session ID</label>
          <input id="session" type="text" />
        </div>
        <div>
          <label for="scenario">Scenario (persona brief)</label>
          <input id="scenario" type="text" placeholder="first‚Äëtime intake; social anxiety in group settings" />
        </div>
      </div>

      <label class="row mt16" style="gap:8px;align-items:center;">
        <input id="speakToggle" type="checkbox" checked />
        <span>üîä Speak client reply</span>
      </label>
      <div class="grid mt8">
        <div>
          <label for="voiceSelect">Voice</label>
          <select id="voiceSelect"></select>
        </div>
        <div>
          <label for="rate">Rate</label>
          <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0">
        </div>
      </div>

      <div class="mt16">
        <span id="status" class="pill">idle</span>
      </div>

      <div class="row mt16">
        <button id="btnRecord" class="btn">‚óè Start</button>
        <button id="btnStop" class="btn warn" disabled>‚ñ† Stop</button>
        <button id="btnSend" class="btn good" disabled>‚Üë Send to n8n</button>
        <button id="btnReset" class="btn ghost" disabled>Reset</button>
      </div>

      <div class="mt16">
        <label>Preview</label>
        <audio id="player" controls></audio>
        <div class="footer">Captured as <span class="mono">audio/webm; codecs=opus</span>. n8n forwards this to your
          local Whisper endpoint.</div>
      </div>

      <div class="grid mt24">
        <div>
          <label>Request (FormData fields)</label>
          <pre id="req" class="mono"></pre>
        </div>
        <div>
          <label>Response (JSON)</label>
          <pre id="res" class="mono"></pre>
        </div>
      </div>

      <div class="footer mt12">
        Tip: Use HTTPS for mic access. Most browsers require a secure origin for <span class="mono">getUserMedia</span>.
      </div>
    </div>
  </div>

  <script>
    (function () {
      const els = {
        webhook: document.getElementById('webhook'),
        apikey: document.getElementById('apikey'),
        session: document.getElementById('session'),
        scenario: document.getElementById('scenario'),
        status: document.getElementById('status'),
        btnRecord: document.getElementById('btnRecord'),
        btnStop: document.getElementById('btnStop'),
        btnSend: document.getElementById('btnSend'),
        btnReset: document.getElementById('btnReset'),
        player: document.getElementById('player'),
        req: document.getElementById('req'),
        res: document.getElementById('res'),
      };

      // ---- SpeechSynthesis helpers ----
      const tts = {
        voices: [],
        init() {
          const select = document.getElementById('voiceSelect');
          const load = () => {
            this.voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
            select.innerHTML = '';
            this.voices.forEach((v, i) => {
              const opt = document.createElement('option');
              opt.value = i;
              opt.textContent = `${v.name} (${v.lang})`;
              select.appendChild(opt);
            });
          };
          load();
          speechSynthesis.onvoiceschanged = load;
        },
        speak(text) {
          if (!document.getElementById('speakToggle').checked || !text) return;
          speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(String(text).trim());
          const voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
          const idx = parseInt(document.getElementById('voiceSelect').value || '0', 10);
          if (voices[idx]) u.voice = voices[idx];
          u.rate = parseFloat(document.getElementById('rate').value || '1.0');
          u.pitch = 1.0; u.lang = (u.voice && u.voice.lang) || 'en-US';
          speechSynthesis.speak(u);
        }
      };
      tts.init();

      // Defaults: generate a simple session id and example webhook placeholder
      els.session.value = `demo-${Math.random().toString(36).slice(2, 8)}`;

      let mediaRecorder = null;
      let chunks = [];
      let blob = null;

      function setStatus(text, color) {
        els.status.textContent = text;
        els.status.style.borderColor = 'rgba(255,255,255,.25)';
        if (color) els.status.style.background = color;
      }

      async function startRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const options = { mimeType: 'audio/webm;codecs=opus' };
          mediaRecorder = new MediaRecorder(stream, options);
          chunks = [];
          mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
          mediaRecorder.onstop = () => {
            blob = new Blob(chunks, { type: 'audio/webm;codecs=opus' });
            els.player.src = URL.createObjectURL(blob);
            els.btnSend.disabled = false;
            els.btnReset.disabled = false;
            setStatus(`ready to send (${Math.round(blob.size / 1024)} KB)`, '#26305c');
          };
          mediaRecorder.start();
          setStatus('recording‚Ä¶', '#1c274a');
          els.btnRecord.disabled = true;
          els.btnStop.disabled = false;
        } catch (err) {
          setStatus('mic permission denied', '#5c1c1c');
          console.error(err);
          alert('Microphone access failed. Use HTTPS and allow mic permissions.');
        }
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          els.btnStop.disabled = true;
          els.btnRecord.disabled = false;
        }
      }

      function resetAll() {
        blob = null; chunks = []; els.player.src = '';
        els.btnSend.disabled = true; els.btnReset.disabled = true; els.res.textContent = '';
        setStatus('idle');
      }

      async function sendToWebhook() {
        if (!blob) { alert('Record something first'); return; }
        const url = els.webhook.value.trim();
        if (!url) { alert('Enter your n8n Webhook URL'); return; }

        const form = new FormData();
        // Give the file a predictable filename/field that n8n expects
        const file = new File([blob], `therapist_${Date.now()}.webm`, { type: blob.type });
        form.append('file', file);
        form.append('session_id', els.session.value.trim());
        form.append('scenario', els.scenario.value.trim());

        // Show a preview of the form fields
        els.req.textContent = `Fields -> file: ${file.name} (${file.type}, ${Math.round(file.size / 1024)} KB)\n` +
          `session_id: ${form.get('session_id')}\n` +
          `scenario: ${form.get('scenario')}`;

        setStatus('uploading‚Ä¶', '#1c274a');
        els.btnSend.disabled = true;

        try {
          const headers = {};
          const k = els.apikey.value.trim();
          if (k) headers['x-caisa-key'] = k;

          const res = await fetch(url, { method: 'POST', body: form, headers });
          const contentType = res.headers.get('content-type') || '';
          let payload;
          if (contentType.includes('application/json')) payload = await res.json();
          else payload = await res.text();
          els.res.textContent = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
          setStatus(res.ok ? 'uploaded' : `error ${res.status}`, res.ok ? '#1f3b2e' : '#5c1c1c');
          const clientText = (typeof payload === 'object' && payload) ? (payload.client_text || '') : '';
          tts.speak(clientText);
        } catch (err) {
          console.error(err);
          setStatus('network error', '#5c1c1c');
          els.res.textContent = String(err);
        } finally {
          els.btnSend.disabled = false;
        }
      }

      els.btnRecord.addEventListener('click', startRecording);
      els.btnStop.addEventListener('click', stopRecording);
      els.btnSend.addEventListener('click', sendToWebhook);
      els.btnReset.addEventListener('click', resetAll);
    })();
  </script>
</body>

</html>